<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Prueba QR (Standalone)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui, sans-serif; padding:16px; max-width:680px; margin:0 auto;}
    #region{width:100%; max-width:520px; margin:12px auto;}
    button{padding:10px 14px; font-weight:700; border-radius:10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer;}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0;}
    .log{font:14px/1.45 monospace; white-space:pre-wrap; background:#f6f8fa; border:1px solid #ddd; padding:10px; border-radius:10px; min-height:80px;}
    input[type=file]{display:none;}
    label.file{padding:10px 14px; border:1px dashed #bbb; border-radius:10px; cursor:pointer; background:#fff;}
  </style>
</head>
<body>
  <h1>Prueba lector QR</h1>
  <p>Debes ver un diálogo de permisos de cámara. Si no aparece, revisa que la URL sea <b>https://</b> y los permisos del sitio.</p>

  <div id="region"></div>

  <div class="row">
    <button id="btnStart">Iniciar cámara</button>
    <button id="btnStop">Detener</button>
    <label class="file" for="fileInp">Subir foto del código</label>
    <input id="fileInp" type="file" accept="image/*" capture="environment">
  </div>

  <div class="log" id="log">Listo…</div>

  <script src="https://unpkg.com/html5-qrcode@2.3.10"></script>
  <script>
    const SECURE = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
    const log = (m)=>{ document.getElementById('log').textContent += "\\n" + m; };
    let reader=null;

    async function start(){
      if(!SECURE){ alert("La cámara requiere HTTPS o localhost"); return; }
      if(!window.Html5Qrcode){ alert("No se cargó html5-qrcode"); return; }
      try{
        if(!reader) reader = new Html5Qrcode("region", { verbose:true });

        // Estrategia 1: listar cámaras y usar la trasera
        let started = false;
        try{
          const cams = await Html5Qrcode.getCameras();
          log("Cámaras detectadas: " + (cams?.length || 0));
          if(cams?.length){
            const back = cams.find(c => /back|rear|environment|trasera/i.test(c.label));
            const camId = (back || cams[0]).id;
            await reader.start({deviceId:{exact:camId}}, {fps:10, qrbox:{width:250,height:250}}, 
              (txt)=>{ log("QR: " + txt); alert("Leído: " + txt); },
              ()=>{}
            );
            log("Cámara iniciada con: " + (back?.label || cams[0].label || camId));
            started = true;
          }
        }catch(e){ log("getCameras() dio error: " + e); }

        // Estrategia 2: facingMode environment
        if(!started){
          try{
            await reader.start({ facingMode: "environment" }, {fps:10, qrbox:{width:250,height:250}}, 
              (txt)=>{ log("QR: " + txt); alert("Leído: " + txt); }, ()=>{});
            log("Cámara iniciada con facingMode: environment");
            started = true;
          }catch(e2){
            log("facingMode environment falló: " + e2);
          }
        }

        // Estrategia 3: facingMode user
        if(!started){
          await reader.start({ facingMode: "user" }, {fps:10, qrbox:{width:250,height:250}}, 
            (txt)=>{ log("QR: " + txt); alert("Leído: " + txt); }, ()=>{});
          log("Cámara iniciada con facingMode: user (frontal)");
        }
      }catch(e){
        console.error(e); log("Error fatal: " + (e?.message || e));
        alert("No se pudo iniciar la cámara: " + (e?.message || e));
        try{ await stop(); }catch{}
      }
    }
    async function stop(){
      if(reader && reader._isScanning){ await reader.stop(); await reader.clear(); log("Cámara detenida."); }
    }
    // Escaneo desde imagen
    document.getElementById('fileInp').addEventListener('change', async (ev)=>{
      const f = ev.target.files?.[0];
      if(!f) return;
      try{
        if(!reader) reader = new Html5Qrcode("region", { verbose:true });
        const result = await reader.scanFile(f, true);
        log("QR (archivo): " + result);
        alert("Leído (archivo): " + result);
      }catch(e){
        console.error(e); log("scanFile error: " + e);
        alert("No se pudo leer el código de la imagen.");
      }
    });
    document.getElementById('btnStart').onclick = start;
    document.getElementById('btnStop').onclick  = stop;
  </script>
</body>
</html>


